<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TagPro - Sistema de An√°lisis de Partidos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .header { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .btn { background: #ec4899; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s; margin-right: 10px; }
        .btn:hover { background: #db2777; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #ec4899; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; padding: 25px; border-radius: 12px; }
        .stat-label { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
        .stat-value { font-size: 36px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-not-started { background: #fef3c7; color: #92400e; }
        .badge-in-progress { background: #dbeafe; color: #1e40af; }
        .badge-finished { background: #d1fae5; color: #065f46; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .center-content { max-width: 500px; margin: 100px auto; }
        
        .event-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .event-btn { padding: 15px; border: 2px solid #e1e8ed; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-align: center; }
        .event-btn:hover { border-color: #ec4899; background: #fce7f3; }
        .event-btn.offensive { border-color: #10b981; }
        .event-btn.defensive { border-color: #3b82f6; }
        .event-btn.other { border-color: #f59e0b; }
        
        .match-header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .score-display { font-size: 48px; font-weight: bold; text-align: center; color: #ec4899; margin: 20px 0; }
        .timer { font-size: 32px; font-weight: bold; text-align: center; color: #666; margin-bottom: 20px; }
        
        .player-select { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .player-list { max-height: 300px; overflow-y: auto; border: 2px solid #e1e8ed; border-radius: 8px; padding: 10px; }
        .player-item { padding: 10px; margin-bottom: 5px; background: #f8f9fa; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .player-item:hover { background: #e9ecef; }
        .player-item.selected { background: #fce7f3; border: 2px solid #ec4899; }
        
        .zone-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .zone-btn { padding: 20px; border: 2px solid #e1e8ed; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center; }
        .zone-btn:hover { border-color: #ec4899; background: #fce7f3; }
        .zone-btn.selected { background: #ec4899; color: white; border-color: #ec4899; }
    </style>
</head>
<body>
    <div class="container">
        <!-- PANTALLA VALIDACI√ìN LICENCIA -->
        <div id="licenseScreen" class="center-content">
            <div class="card">
                <h1 style="text-align: center; margin-bottom: 30px; color: #ec4899;">üìä TagPro</h1>
                <div class="form-group">
                    <label>Introduce tu clave de licencia TagPro:</label>
                    <input type="text" id="licenseInput" placeholder="TAGPRO-XXXX-XXXX-XXXX" style="text-transform: uppercase;">
                </div>
                <button class="btn" onclick="validateLicense()" style="width: 100%;">Validar Licencia</button>
                <div id="licenseError" class="alert alert-danger hidden" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- PANTALLA REGISTRO ENTRENADOR -->
        <div id="coachRegisterScreen" class="center-content hidden">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 20px;">Registro de Entrenador</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px;">Licencia TagPro validada. Crea tu cuenta.</p>
                <div class="form-group">
                    <label>Nombre del Equipo:</label>
                    <input type="text" id="teamName" placeholder="Ej: FC Barcelona">
                </div>
                <div class="form-group">
                    <label>Tu Nombre Completo:</label>
                    <input type="text" id="coachName" placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="coachEmail" placeholder="entrenador@equipo.com">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="coachPassword" placeholder="M√≠nimo 6 caracteres">
                </div>
                <button class="btn" onclick="registerCoach()" style="width: 100%;">Crear Cuenta</button>
                <div id="registerError" class="alert alert-danger hidden" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- PANTALLA LOGIN -->
        <div id="loginScreen" class="center-content hidden">
            <div class="card">
                <h1 style="text-align: center; margin-bottom: 30px; color: #ec4899;">üìä TagPro</h1>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="loginEmail" placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="loginPassword">
                </div>
                <button class="btn" onclick="login()" style="width: 100%;">Iniciar Sesi√≥n</button>
                <div id="loginError" class="alert alert-danger hidden" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- PANEL PRINCIPAL -->
        <div id="mainPanel" class="hidden">
            <div class="header">
                <div>
                    <h1>üìä TagPro - An√°lisis de Partidos</h1>
                    <p id="teamNameDisplay" style="opacity: 0.9; margin-top: 5px;"></p>
                </div>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- TABS -->
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="showTab('matches')">‚öΩ Partidos</button>
                <button class="btn btn-secondary" onclick="showTab('newMatch')">+ Nuevo Partido</button>
            </div>

            <!-- TAB: LISTA DE PARTIDOS -->
            <div id="matchesTab" class="card">
                <h2>Mis Partidos</h2>
                <div id="matchesList"></div>
            </div>

            <!-- TAB: NUEVO PARTIDO -->
            <div id="newMatchTab" class="card hidden">
                <h2>Crear Nuevo Partido</h2>
                <div class="form-group">
                    <label>Equipo Rival:</label>
                    <input type="text" id="rivalName" placeholder="Nombre del equipo rival">
                </div>
                <div class="form-group">
                    <label>Fecha del Partido:</label>
                    <input type="date" id="matchDate">
                </div>
                <div class="form-group">
                    <label>Competici√≥n:</label>
                    <input type="text" id="competition" placeholder="Liga, Copa, Amistoso, etc.">
                </div>
                <div class="form-group">
                    <label>Tipo de Partido:</label>
                    <select id="isHome">
                        <option value="true">Local (en casa)</option>
                        <option value="false">Visitante (fuera)</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="createMatch()">Crear Partido</button>
                <button class="btn btn-secondary" onclick="showTab('matches')">Cancelar</button>
            </div>

            <!-- TAB: DETALLE PARTIDO -->
            <div id="matchDetailTab" class="card hidden">
                <div class="match-header">
                    <h2 id="matchTitle"></h2>
                    <div class="score-display" id="scoreDisplay">0 - 0</div>
                    <div style="text-align: center;">
                        <span id="matchStatus" class="badge"></span>
                    </div>
                </div>

                <div style="margin-bottom: 20px; text-align: center;">
                    <button class="btn btn-success" id="startMatchBtn" onclick="startMatch()">Iniciar Partido</button>
                    <button class="btn btn-danger" id="finishMatchBtn" onclick="finishMatch()" style="display: none;">Finalizar Partido</button>
                    <button class="btn btn-secondary" onclick="showTab('matches')">Volver a Partidos</button>
                </div>

                <!-- SELECCI√ìN DE JUGADORES -->
                <div id="playerSelectionSection">
                    <h3>Seleccionar Jugadores</h3>
                    <div class="player-select">
                        <div>
                            <h4>Mi Equipo</h4>
                            <div class="player-list" id="ownPlayersList"></div>
                        </div>
                        <div>
                            <h4>Equipo Rival</h4>
                            <input type="text" id="rivalPlayerName" placeholder="Nombre jugador rival" style="margin-bottom: 10px;">
                            <button class="btn btn-success" onclick="addRivalPlayer()">+ Agregar</button>
                            <div class="player-list" id="rivalPlayersList" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="confirmPlayers()">Confirmar Jugadores</button>
                </div>

                <!-- TAGGING DE EVENTOS -->
                <div id="taggingSection" class="hidden">
                    <div class="timer">Minuto: <span id="minuteDisplay">0</span></div>
                    
                    <h3>Registrar Evento</h3>
                    
                    <div class="form-group">
                        <label>Selecciona Equipo:</label>
                        <select id="eventTeam" onchange="loadEventPlayers()">
                            <option value="">-- Selecciona equipo --</option>
                            <option value="own">Mi Equipo</option>
                            <option value="rival">Equipo Rival</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Selecciona Jugador:</label>
                        <select id="eventPlayer">
                            <option value="">-- Primero selecciona equipo --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Zona del Campo:</label>
                        <div class="zone-selector">
                            <button class="zone-btn" onclick="selectZone('defensive')">üõ°Ô∏è Defensiva</button>
                            <button class="zone-btn" onclick="selectZone('midfield')">‚ö° Media</button>
                            <button class="zone-btn" onclick="selectZone('offensive')">‚öîÔ∏è Ofensiva</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Evento:</label>
                        <div class="event-buttons">
                            <button class="event-btn offensive" onclick="recordEvent('goal', 'offensive')">‚öΩ Gol</button>
                            <button class="event-btn offensive" onclick="recordEvent('shot_on_target', 'offensive')">üéØ Tiro a Puerta</button>
                            <button class="event-btn offensive" onclick="recordEvent('shot_off_target', 'offensive')">üì§ Tiro Fuera</button>
                            <button class="event-btn offensive" onclick="recordEvent('shot_blocked', 'offensive')">üö´ Tiro Bloqueado</button>
                            <button class="event-btn offensive" onclick="recordEvent('pass_completed', 'offensive')">‚úÖ Pase Completado</button>
                            <button class="event-btn offensive" onclick="recordEvent('pass_failed', 'offensive')">‚ùå Pase Fallado</button>
                            <button class="event-btn defensive" onclick="recordEvent('interception', 'defensive')">üõ°Ô∏è Intercepci√≥n</button>
                            <button class="event-btn defensive" onclick="recordEvent('tackle_won', 'defensive')">ü¶µ Entrada Limpia</button>
                            <button class="event-btn defensive" onclick="recordEvent('tackle_foul', 'defensive')">‚ö†Ô∏è Entrada con Falta</button>
                            <button class="event-btn defensive" onclick="recordEvent('clearance', 'defensive')">üß§ Despeje</button>
                            <button class="event-btn defensive" onclick="recordEvent('recovery', 'defensive')">üìç Recuperaci√≥n</button>
                            <button class="event-btn other" onclick="recordEvent('ball_lost', 'other')">‚ùå P√©rdida</button>
                            <button class="event-btn other" onclick="recordEvent('yellow_card', 'other')">üü® Amarilla</button>
                            <button class="event-btn other" onclick="recordEvent('red_card', 'other')">üü• Roja</button>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Eventos Registrados</h3>
                    <div id="eventsList"></div>
                </div>

                <!-- ESTAD√çSTICAS -->
                <div id="statsSection" class="hidden">
                    <h3>Estad√≠sticas del Partido</h3>
                    <div id="matchStats"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var SUPABASE_URL = 'https://aeqtbqcdylemvacvnpst.supabase.co/rest/v1';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlcXRicWNkeWxlbXZhY3ZucHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjA4NDQsImV4cCI6MjA3ODUzNjg0NH0.7M3VpZ6J4tcZIXgoUzJUwHjlGiGYwyRlJbK0-GKqEiE';
        
        var currentUser = null;
        var currentLicense = null;
        var currentMatch = null;
        var matchPlayers = { own: [], rival: [] };
        var selectedZone = '';
        var matchMinute = 0;
        var matchInterval = null;

        window.onload = function() {
            var session = localStorage.getItem('tagproSession');
            if (session) {
                currentUser = JSON.parse(session);
                loadMainPanel();
            } else {
                showScreen('licenseScreen');
            }
        };

        function showScreen(screenId) {
            var screens = ['licenseScreen', 'coachRegisterScreen', 'loginScreen', 'mainPanel'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).classList.add('hidden');
            }
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMessage(elementId, message, type) {
            var el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'alert alert-' + type;
            el.classList.remove('hidden');
        }

        function validateLicense() {
            var licenseKey = document.getElementById('licenseInput').value.trim().toUpperCase();
            if (!licenseKey) {
                showMessage('licenseError', 'Por favor introduce una clave de licencia', 'danger');
                return;
            }

            fetch(SUPABASE_URL + '/licenses?license_key=eq.' + licenseKey + '&product_type=eq.tagpro', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.length === 0) {
                    showMessage('licenseError', 'Licencia TagPro no v√°lida', 'danger');
                    return;
                }
                
                var license = data[0];
                currentLicense = license;

                if (license.status === 'revoked') {
                    showMessage('licenseError', 'Esta licencia ha sido revocada', 'danger');
                    return;
                }

                if (license.status === 'pending') {
                    showScreen('coachRegisterScreen');
                } else if (license.status === 'active') {
                    showScreen('loginScreen');
                }
            })
            .catch(function() {
                showMessage('licenseError', 'Error al validar licencia', 'danger');
            });
        }

        function registerCoach() {
            var teamName = document.getElementById('teamName').value.trim();
            var coachName = document.getElementById('coachName').value.trim();
            var email = document.getElementById('coachEmail').value.trim();
            var password = document.getElementById('coachPassword').value;

            if (!teamName || !coachName || !email || !password) {
                showMessage('registerError', 'Todos los campos son obligatorios', 'danger');
                return;
            }

            if (password.length < 6) {
                showMessage('registerError', 'La contrase√±a debe tener m√≠nimo 6 caracteres', 'danger');
                return;
            }

            fetch(SUPABASE_URL + '/teams', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    license_id: currentLicense.id,
                    team_name: teamName,
                    player_count: 0
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(teamData) {
                var team = teamData[0];
                
                return fetch(SUPABASE_URL + '/users', {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        team_id: team.id,
                        email: email,
                        password_hash: btoa(password),
                        full_name: coachName,
                        role: 'coach'
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(userData) {
                    return fetch(SUPABASE_URL + '/licenses?id=eq.' + currentLicense.id, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'active',
                            activated_at: new Date().toISOString(),
                            team_name: teamName,
                            coach_email: email
                        })
                    })
                    .then(function() {
                        return fetch(SUPABASE_URL + '/teams?id=eq.' + team.id, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': 'Bearer ' + SUPABASE_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ coach_id: userData[0].id })
                        });
                    })
                    .then(function() {
                        currentUser = { id: userData[0].id, email: email, name: coachName, role: 'coach', team_id: team.id, team_name: teamName };
                        localStorage.setItem('tagproSession', JSON.stringify(currentUser));
                        loadMainPanel();
                    });
                });
            })
            .catch(function() {
                showMessage('registerError', 'Error al crear cuenta', 'danger');
            });
        }

        function login() {
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginError', 'Email y contrase√±a son obligatorios', 'danger');
                return;
            }

            fetch(SUPABASE_URL + '/users?email=eq.' + email + '&password_hash=eq.' + btoa(password), {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.length === 0) {
                    showMessage('loginError', 'Email o contrase√±a incorrectos', 'danger');
                    return;
                }

                var user = data[0];
                
                return fetch(SUPABASE_URL + '/teams?id=eq.' + user.team_id, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                })
                .then(function(r) { return r.json(); })
                .then(function(teamData) {
                    currentUser = {
                        id: user.id,
                        email: user.email,
                        name: user.full_name,
                        role: user.role,
                        team_id: user.team_id,
                        team_name: teamData[0].team_name
                    };
                    localStorage.setItem('tagproSession', JSON.stringify(currentUser));
                    loadMainPanel();
                });
            })
            .catch(function() {
                showMessage('loginError', 'Error al iniciar sesi√≥n', 'danger');
            });
        }

        function logout() {
            localStorage.removeItem('tagproSession');
            currentUser = null;
            showScreen('loginScreen');
        }

        function loadMainPanel() {
            showScreen('mainPanel');
            document.getElementById('teamNameDisplay').textContent = currentUser.team_name;
            showTab('matches');
        }

        function showTab(tab) {
            document.getElementById('matchesTab').classList.add('hidden');
            document.getElementById('newMatchTab').classList.add('hidden');
            document.getElementById('matchDetailTab').classList.add('hidden');

            if (tab === 'matches') {
                document.getElementById('matchesTab').classList.remove('hidden');
                loadMatches();
            } else if (tab === 'newMatch') {
                document.getElementById('newMatchTab').classList.remove('hidden');
                document.getElementById('matchDate').valueAsDate = new Date();
            }
        }

        function loadMatches() {
            fetch(SUPABASE_URL + '/matches?team_id=eq.' + currentUser.team_id + '&select=*&order=match_date.desc', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(matches) {
                var html = '<table><thead><tr><th>Rival</th><th>Fecha</th><th>Competici√≥n</th><th>Resultado</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
                
                if (matches.length === 0) {
                    html += '<tr><td colspan="6" style="text-align: center; color: #999;">No hay partidos. Crea el primero.</td></tr>';
                } else {
                    for (var i = 0; i < matches.length; i++) {
                        var m = matches[i];
                        var badge = '';
                        if (m.status === 'not_started') badge = '<span class="badge badge-not-started">No Iniciado</span>';
                        else if (m.status === 'in_progress') badge = '<span class="badge badge-in-progress">En Curso</span>';
                        else badge = '<span class="badge badge-finished">Finalizado</span>';
                        
                        var score = m.is_home ? m.home_score + ' - ' + m.away_score : m.away_score + ' - ' + m.home_score;
                        var date = new Date(m.match_date).toLocaleDateString('es-ES');
                        
                        html += '<tr>';
                        html += '<td>' + (m.is_home ? 'vs ' : '@ ') + m.rival_name + '</td>';
                        html += '<td>' + date + '</td>';
                        html += '<td>' + (m.competition || '-') + '</td>';
                        html += '<td style="font-weight: bold;">' + score + '</td>';
                        html += '<td>' + badge + '</td>';
                        html += '<td><button class="btn" style="padding: 6px 12px; font-size: 14px;" onclick="viewMatch(\'' + m.id + '\')">Ver Detalle</button></td>';
                        html += '</tr>';
                    }
                }
                html += '</tbody></table>';
                document.getElementById('matchesList').innerHTML = html;
            });
        }

        function createMatch() {
            var rivalName = document.getElementById('rivalName').value.trim();
            var matchDate = document.getElementById('matchDate').value;
            var competition = document.getElementById('competition').value.trim();
            var isHome = document.getElementById('isHome').value === 'true';

            if (!rivalName || !matchDate) {
                alert('Nombre del rival y fecha son obligatorios');
                return;
            }

            fetch(SUPABASE_URL + '/matches', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    team_id: currentUser.team_id,
                    rival_name: rivalName,
                    match_date: matchDate,
                    competition: competition,
                    is_home: isHome,
                    status: 'not_started'
                })
            })
            .then(function(r) { return r.json(); })
            .then(function() {
                document.getElementById('rivalName').value = '';
                document.getElementById('competition').value = '';
                showTab('matches');
            });
        }

        function viewMatch(matchId) {
            fetch(SUPABASE_URL + '/matches?id=eq.' + matchId, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                currentMatch = data[0];
                displayMatchDetail();
            });
        }

        function displayMatchDetail() {
            document.getElementById('matchesTab').classList.add('hidden');
            document.getElementById('matchDetailTab').classList.remove('hidden');
            
            var title = (currentMatch.is_home ? 'vs ' : '@ ') + currentMatch.rival_name;
            document.getElementById('matchTitle').textContent = title;
            
            var score = currentMatch.is_home ? currentMatch.home_score + ' - ' + currentMatch.away_score : currentMatch.away_score + ' - ' + currentMatch.home_score;
            document.getElementById('scoreDisplay').textContent = score;
            
            var statusBadge = document.getElementById('matchStatus');
            if (currentMatch.status === 'not_started') {
                statusBadge.textContent = 'No Iniciado';
                statusBadge.className = 'badge badge-not-started';
                document.getElementById('startMatchBtn').style.display = 'inline-block';
                document.getElementById('finishMatchBtn').style.display = 'none';
                document.getElementById('playerSelectionSection').style.display = 'block';
                document.getElementById('taggingSection').classList.add('hidden');
                loadMatchPlayers();
            } else if (currentMatch.status === 'in_progress') {
                statusBadge.textContent = 'En Curso';
                statusBadge.className = 'badge badge-in-progress';
                document.getElementById('startMatchBtn').style.display = 'none';
                document.getElementById('finishMatchBtn').style.display = 'inline-block';
                document.getElementById('playerSelectionSection').style.display = 'none';
                document.getElementById('taggingSection').classList.remove('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                loadMatchEvents();
                loadMatchStats();
                startMinuteCounter();
            } else {
                statusBadge.textContent = 'Finalizado';
                statusBadge.className = 'badge badge-finished';
                document.getElementById('startMatchBtn').style.display = 'none';
                document.getElementById('finishMatchBtn').style.display = 'none';
                document.getElementById('playerSelectionSection').style.display = 'none';
                document.getElementById('taggingSection').classList.add('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                loadMatchStats();
            }
        }

        function loadMatchPlayers() {
            fetch(SUPABASE_URL + '/users?team_id=eq.' + currentUser.team_id + '&role=eq.player', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(players) {
                var html = '';
                for (var i = 0; i < players.length; i++) {
                    html += '<div class="player-item" onclick="togglePlayer(\'' + players[i].id + '\', \'' + players[i].full_name + '\', \'own\')">';
                    html += '<span>' + players[i].full_name + '</span>';
                    html += '<span id="check-own-' + players[i].id + '">‚òê</span>';
                    html += '</div>';
                }
                document.getElementById('ownPlayersList').innerHTML = html;
            });

            fetch(SUPABASE_URL + '/match_players?match_id=eq.' + currentMatch.id + '&team_type=eq.rival', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(rivals) {
                var html = '';
                for (var i = 0; i < rivals.length; i++) {
                    html += '<div class="player-item" onclick="togglePlayer(null, \'' + rivals[i].player_name + '\', \'rival\')">';
                    html += '<span>' + rivals[i].player_name + '</span>';
                    html += '<span id="check-rival-' + i + '">‚òë</span>';
                    html += '</div>';
                }
                document.getElementById('rivalPlayersList').innerHTML = html;
            });
        }

        function togglePlayer(playerId, playerName, teamType) {
            var player = { id: playerId, name: playerName };
            var index = -1;
            
            for (var i = 0; i < matchPlayers[teamType].length; i++) {
                if (matchPlayers[teamType][i].name === playerName) {
                    index = i;
                    break;
                }
            }
            
            if (index > -1) {
                matchPlayers[teamType].splice(index, 1);
                if (playerId) {
                    document.getElementById('check-' + teamType + '-' + playerId).textContent = '‚òê';
                }
            } else {
                matchPlayers[teamType].push(player);
                if (playerId) {
                    document.getElementById('check-' + teamType + '-' + playerId).textContent = '‚òë';
                }
            }
        }

        function addRivalPlayer() {
            var name = document.getElementById('rivalPlayerName').value.trim();
            if (!name) return;

            fetch(SUPABASE_URL + '/match_players', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    match_id: currentMatch.id,
                    player_name: name,
                    team_type: 'rival'
                })
            })
            .then(function() {
                document.getElementById('rivalPlayerName').value = '';
                loadMatchPlayers();
            });
        }

        function confirmPlayers() {
            if (matchPlayers.own.length === 0) {
                alert('Debes seleccionar al menos un jugador de tu equipo');
                return;
            }

            var promises = [];
            for (var i = 0; i < matchPlayers.own.length; i++) {
                var p = matchPlayers.own[i];
                promises.push(
                    fetch(SUPABASE_URL + '/match_players', {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            match_id: currentMatch.id,
                            player_id: p.id,
                            player_name: p.name,
                            team_type: 'own'
                        })
                    })
                );
            }

            Promise.all(promises).then(function() {
                alert('Jugadores confirmados');
                matchPlayers = { own: [], rival: [] };
            });
        }

        function startMatch() {
            fetch(SUPABASE_URL + '/matches?id=eq.' + currentMatch.id, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'in_progress' })
            })
            .then(function() {
                currentMatch.status = 'in_progress';
                displayMatchDetail();
            });
        }

        function finishMatch() {
            if (!confirm('¬øFinalizar el partido?')) return;
            
            if (matchInterval) {
                clearInterval(matchInterval);
            }

            fetch(SUPABASE_URL + '/matches?id=eq.' + currentMatch.id, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'finished' })
            })
            .then(function() {
                currentMatch.status = 'finished';
                displayMatchDetail();
            });
        }

        function startMinuteCounter() {
            if (matchInterval) clearInterval(matchInterval);
            
            matchMinute = 0;
            matchInterval = setInterval(function() {
                matchMinute++;
                document.getElementById('minuteDisplay').textContent = matchMinute;
            }, 60000);
        }

        function loadEventPlayers() {
            var teamType = document.getElementById('eventTeam').value;
            if (!teamType) {
                document.getElementById('eventPlayer').innerHTML = '<option value="">-- Primero selecciona equipo --</option>';
                return;
            }

            fetch(SUPABASE_URL + '/match_players?match_id=eq.' + currentMatch.id + '&team_type=eq.' + teamType, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(players) {
                var html = '<option value="">-- Selecciona jugador --</option>';
                for (var i = 0; i < players.length; i++) {
                    html += '<option value="' + (players[i].player_id || players[i].player_name) + '">' + players[i].player_name + '</option>';
                }
                document.getElementById('eventPlayer').innerHTML = html;
            });
        }

        function selectZone(zone) {
            selectedZone = zone;
            var buttons = document.getElementsByClassName('zone-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('selected');
            }
            event.target.classList.add('selected');
        }

        function recordEvent(eventType, eventCategory) {
            var teamType = document.getElementById('eventTeam').value;
            var playerSelect = document.getElementById('eventPlayer');
            var playerValue = playerSelect.value;
            var playerName = playerSelect.options[playerSelect.selectedIndex].text;

            if (!teamType || !playerValue || !selectedZone) {
                alert('Debes seleccionar equipo, jugador y zona del campo');
                return;
            }

            var minute = matchMinute || parseInt(prompt('¬øEn qu√© minuto ocurri√≥?', '0')) || 0;

            fetch(SUPABASE_URL + '/match_events', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    match_id: currentMatch.id,
                    player_id: teamType === 'own' ? playerValue : null,
                    player_name: playerName,
                    team_type: teamType,
                    event_type: eventType,
                    event_category: eventCategory,
                    minute: minute,
                    field_zone: selectedZone
                })
            })
            .then(function() {
                if (eventType === 'goal') {
                    if (teamType === 'own') {
                        if (currentMatch.is_home) currentMatch.home_score++;
                        else currentMatch.away_score++;
                    } else {
                        if (currentMatch.is_home) currentMatch.away_score++;
                        else currentMatch.home_score++;
                    }
                    
                    fetch(SUPABASE_URL + '/matches?id=eq.' + currentMatch.id, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            home_score: currentMatch.home_score,
                            away_score: currentMatch.away_score
                        })
                    })
                    .then(function() {
                        var score = currentMatch.is_home ? currentMatch.home_score + ' - ' + currentMatch.away_score : currentMatch.away_score + ' - ' + currentMatch.home_score;
                        document.getElementById('scoreDisplay').textContent = score;
                    });
                }
                
                loadMatchEvents();
                loadMatchStats();
            });
        }

        function loadMatchEvents() {
            fetch(SUPABASE_URL + '/match_events?match_id=eq.' + currentMatch.id + '&select=*&order=minute.desc,created_at.desc', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(events) {
                var eventNames = {
                    'goal': '‚öΩ Gol',
                    'shot_on_target': 'üéØ Tiro a Puerta',
                    'shot_off_target': 'üì§ Tiro Fuera',
                    'shot_blocked': 'üö´ Tiro Bloqueado',
                    'pass_completed': '‚úÖ Pase Completado',
                    'pass_failed': '‚ùå Pase Fallado',
                    'interception': 'üõ°Ô∏è Intercepci√≥n',
                    'tackle_won': 'ü¶µ Entrada Limpia',
                    'tackle_foul': '‚ö†Ô∏è Entrada con Falta',
                    'clearance': 'üß§ Despeje',
                    'recovery': 'üìç Recuperaci√≥n',
                    'ball_lost': '‚ùå P√©rdida',
                    'yellow_card': 'üü® Amarilla',
                    'red_card': 'üü• Roja'
                };

                var html = '<table><thead><tr><th>Min</th><th>Jugador</th><th>Equipo</th><th>Evento</th><th>Zona</th></tr></thead><tbody>';
                
                if (events.length === 0) {
                    html += '<tr><td colspan="5" style="text-align: center; color: #999;">No hay eventos registrados</td></tr>';
                } else {
                    for (var i = 0; i < events.length; i++) {
                        var e = events[i];
                        html += '<tr>';
                        html += '<td>' + e.minute + "'</td>";
                        html += '<td>' + e.player_name + '</td>';
                        html += '<td>' + (e.team_type === 'own' ? 'Mi Equipo' : 'Rival') + '</td>';
                        html += '<td>' + eventNames[e.event_type] + '</td>';
                        html += '<td>' + e.field_zone + '</td>';
                        html += '</tr>';
                    }
                }
                html += '</tbody></table>';
                document.getElementById('eventsList').innerHTML = html;
            });
        }

        function loadMatchStats() {
            fetch(SUPABASE_URL + '/match_events?match_id=eq.' + currentMatch.id + '&select=*', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(r) { return r.json(); })
            .then(function(events) {
                var stats = {
                    own: { shots: 0, goals: 0, passes: 0, tackles: 0, fouls: 0, cards: 0 },
                    rival: { shots: 0, goals: 0, passes: 0, tackles: 0, fouls: 0, cards: 0 }
                };

                for (var i = 0; i < events.length; i++) {
                    var e = events[i];
                    var team = e.team_type;
                    
                    if (e.event_type === 'goal') stats[team].goals++;
                    if (e.event_type.includes('shot')) stats[team].shots++;
                    if (e.event_type.includes('pass')) stats[team].passes++;
                    if (e.event_type.includes('tackle')) stats[team].tackles++;
                    if (e.event_type === 'tackle_foul') stats[team].fouls++;
                    if (e.event_type.includes('card')) stats[team].cards++;
                }

                var html = '<div class="stats-grid">';
                html += '<div class="stat-card"><div class="stat-label">Tiros (Mi Equipo)</div><div class="stat-value">' + stats.own.shots + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">Tiros (Rival)</div><div class="stat-value">' + stats.rival.shots + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">Pases (Mi Equipo)</div><div class="stat-value">' + stats.own.passes + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">Pases (Rival)</div><div class="stat-value">' + stats.rival.passes + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">Entradas (Mi Equipo)</div><div class="stat-value">' + stats.own.tackles + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">Entradas (Rival)</div><div class="stat-value">' + stats.rival.tackles + '</div></div>';
                html += '</div>';

                document.getElementById('matchStats').innerHTML = html;
            });
        }
    </script>
</body>
</html>